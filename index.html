<html>
  <head>
    <title>Dinner bill calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/ractive"></script>
    <style>
        html { font-size: 110%;}
        input {  margin-right: 0.2em; width: 4em; font-size: 100%; }
        input:invalid { border: 1px red solid; }
        fieldset{
            border: solid 1px blue;
            float:left;
            border-radius: 4px;
        }
        .left { float: left; }
        .clear { clear: both; }
    </style>
    <script>
        var SIMPLE_ARIPHMETIC_EXPR_PATTERN = /^\d+([\+\-\*\/]\d+)*$/;
        function init() {
            var data = {
                subtotal: undefined,
                total: undefined,
                discountRatio: undefined,
                persons: [],
                subtotalSumByPersons: 0,
                totalSumByPersons: 0,
                formatNumber: function(number, decimalPlaces) {
                    return isNaN(number) ? 'N/A' : number.toFixed(decimalPlaces);
                }
            };
            for (var i=0; i<6; i++) {
                data.persons.push({name: i+1, subtotalRaw: 0, subtotal: 0,  total: NaN});
            }
            
            var ractive = new Ractive({
                target: '#target',
                template: '#template',
                data: data
            });
            
            ractive.observe('subtotal', recalc);
            ractive.observe('total', recalc);
            ractive.observe('persons', recalc);
            
            function recalc() {
                data.discountRatio = data.total / data.subtotal; //possible NaN here
                data.subtotalSumByPersons = data.totalSumByPersons = 0;
                for (i = 0; i < data.persons.length; i++) {
                    var person = data.persons[i];
                    person.subtotal = SIMPLE_ARIPHMETIC_EXPR_PATTERN.test(person.subtotalRaw) ? eval(person.subtotalRaw) : NaN;
                    person.total = person.subtotal * data.discountRatio;
                    data.subtotalSumByPersons += person.subtotal;
                    data.totalSumByPersons += person.total;
                }
                ractive.update();
            }
        }
      
    </script>

    <script id="template" type="text/ractive">
        <label class="float">
            Subtotal: <input  type="number" value='{{subtotal}}' required min="1" step="1">
        </label>
        <label class="float">
            Total: <input type="number" value='{{total}}' required min="1" step="1">
        </label>
        <p class="float">Discount ratio: {{formatNumber(discountRatio, 3)}}</p>
        {{#each persons}}
                <fieldset class="clear">
                <legend>Person {{name}}</legend>
                <label>
                    Subtotal: <input  type="string" pattern="\d+([\+\-\*\/]\d+)*$" value='{{subtotalRaw}}' required>={{formatNumber(subtotal, 1)}}
                </label>
                Total: {{formatNumber(total, 1)}}
                </fieldset>
        {{/each}}
        <div class="clear">Subtotal sum by persons: {{subtotalSumByPersons}}</div>
        <div class="clear">Total sum by persons: {{formatNumber(totalSumByPersons, 1)}}</div>
    </script>

  </head>
  
  <body onload="init();">
    <h3>Dinner bill calculator</h3>
    <div id="target"></div>
  </body>
</html>
